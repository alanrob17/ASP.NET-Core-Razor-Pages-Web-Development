<!DOCTYPE html>
<html>
<head>
<title>07-Adding-Login-And-Registration-Using-Identity.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="adding-login-and-registration-using-microsoft-identity">Adding Login and Registration Using Microsoft Identity</h1>
<h2 id="install">Install</h2>
<blockquote>
<p>Microsoft.AspNetCore.Identity.EntityFrameworkCore</p>
</blockquote>
<p>Create a new <code>AuthDbContext</code> class in <code>Data</code> that inherits from <code>IdentityDbContext</code>.</p>
<pre class="hljs"><code><div>    public class AuthDbContext: IdentityDbContext
    {
    }
</div></code></pre>
<p>We will create seed data in the following method.</p>
<pre class="hljs"><code><div>    protected override void OnModelCreating(ModelBuilder builder)
    {
    }
</div></code></pre>
<h2 id="add-connection-string-and-injecting-dbcontext-into-programcs">Add Connection String and Injecting DbContext Into Program.cs</h2>
<p>In <code>appsettings.json</code> add a connection string.</p>
<pre class="hljs"><code><div>    <span class="hljs-string">"AuthDb"</span>: <span class="hljs-string">"Server=TIGER;Database=BlogAuth;Trusted_Connection=True;TrustServerCertificate=True;"</span>
</div></code></pre>
<p>Inject the connection string into <code>Program.cs</code>. We also need to tell our application to use Identity and use the <code>AuthDbContext</code> for our Identity. We will do another injection to add an Identity. We also have to add an Entity Framework store with a type of <code>AuthDbContext</code>.</p>
<pre class="hljs"><code><div>    builder.Services.AddDbContext&lt;AuthDbContext&gt;(options =&gt;
        options.UseSqlServer(builder.Configuration.GetConnectionString(<span class="hljs-string">"AuthDb"</span>)));

    builder.Services.AddIdentity&lt;IdentityUser, IdentityRole&gt;()
        .AddEntityFrameworkStores&lt;AuthDbContext&gt;();
</div></code></pre>
<p>Change the Http Request pipeline. Before we can use <code>Authorization</code> we have to use <code>Authentication</code>.</p>
<pre class="hljs"><code><div>    app.UseAuthentication();
</div></code></pre>
<p>We are now ready to go with using Identity.</p>
<h2 id="running-entity-framework-core-migrations">Running Entity Framework Core migrations</h2>
<p>In Package Manager console.</p>
<pre class="hljs"><code><div>    Add-Migration <span class="hljs-string">"Adding Identity."</span> -Context <span class="hljs-string">"AuthDbContext"</span>
</div></code></pre>
<p><strong>Note:</strong> we have to specify the context we are using because there are two contexts.</p>
<p>To create the database.</p>
<pre class="hljs"><code><div>    Update-Database -Context <span class="hljs-string">"AuthDbContext"</span>
</div></code></pre>
<p>Once again we have to specify the context we are using.</p>
<h2 id="implement-a-user-page">Implement a User page</h2>
<p>Create a new <code>Register</code> class.</p>
<pre class="hljs"><code><div>    [Required]
    public string Username { get; <span class="hljs-built_in">set</span>; }

    [Required]
    [EmailAddress]
    public string Email { get; <span class="hljs-built_in">set</span>; }

    [Required]
    [MinLength(6)]
    public string Password { get; <span class="hljs-built_in">set</span>; }
</div></code></pre>
<p>Create a new Razor page in the <strong>root</strong> of <code>Pages</code> named <code>Register</code>.</p>
<pre class="hljs"><code><div>&lt;div class=<span class="hljs-string">"container mx-auto"</span>&gt;
    &lt;div class=<span class="hljs-string">"row justify-content-center"</span>&gt;
        &lt;div class=<span class="hljs-string">"col-12 col-lg-6"</span>&gt;

            &lt;h1 class=<span class="hljs-string">"mt-5 mb-3 h3"</span>&gt;Register&lt;/h1&gt;

            &lt;partial name=<span class="hljs-string">"_Notification"</span>&gt;

                &lt;form method=<span class="hljs-string">"post"</span>&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;label class=<span class="hljs-string">"form-label"</span>&gt;Username&lt;/label&gt;
                        &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">"text"</span> class=<span class="hljs-string">"form-control"</span> asp-for=<span class="hljs-string">"RegisterViewModel.Username"</span> required /&gt;
                    &lt;/div&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;label class=<span class="hljs-string">"form-label"</span>&gt;Email&lt;/label&gt;
                        &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">"email"</span> class=<span class="hljs-string">"form-control"</span> asp-for=<span class="hljs-string">"RegisterViewModel.Email"</span> required /&gt;
                    &lt;/div&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;label class=<span class="hljs-string">"form-label"</span>&gt;Password&lt;/label&gt;
                        &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">"password"</span> class=<span class="hljs-string">"form-control"</span> asp-for=<span class="hljs-string">"RegisterViewModel.Password"</span> required minlength=<span class="hljs-string">"6"</span> /&gt;
                    &lt;/div&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;button <span class="hljs-built_in">type</span>=<span class="hljs-string">"submit"</span> class=<span class="hljs-string">"btn bg-dark text-light"</span>&gt;Register&lt;/button&gt;
                    &lt;/div&gt;

                &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</div></code></pre>
<p>Now create a constructor in the Code Behind class and a bindable <code>Register</code> instance.</p>
<pre class="hljs"><code><div>    [BindProperty]
    public Register RegisterViewModel { get; <span class="hljs-built_in">set</span>; }

    private <span class="hljs-built_in">readonly</span> UserManager&lt;IdentityUser&gt; userManager;
    
    public RegisterModel(UserManager&lt;IdentityUser&gt; userManager)
    {
        this.userManager = userManager;
    }
</div></code></pre>
<p>Create the <code>OnPost()</code> method.</p>
<pre class="hljs"><code><div>    public async Task&lt;IActionResult&gt; <span class="hljs-function"><span class="hljs-title">OnPost</span></span>()
    {
        var user = new IdentityUser
        {
            UserName = RegisterViewModel.Username,
            Email = RegisterViewModel.Email
        };

        var result = await userManager.CreateAsync(user, RegisterViewModel.Password);

        <span class="hljs-keyword">if</span> (result.Succeeded)
        {
            ViewData[<span class="hljs-string">"Notification"</span>] = new Notification
            {
                Type = Enums.NotificationType.Success,
                Message = <span class="hljs-string">"User registered successfully!"</span>
            };

            <span class="hljs-built_in">return</span> Page();
        }

        ViewData[<span class="hljs-string">"Notification"</span>] = new Notification
        {
            Type = Enums.NotificationType.Error,
            Message = <span class="hljs-string">"User NOT registered!"</span>
        };

        <span class="hljs-built_in">return</span> Page();
    }
</div></code></pre>
<p>We need to add the partial view, <code>_Notification.cshtml</code> to the top of our <code>Register</code> page.</p>
<pre class="hljs"><code><div>    &lt;h1 class=<span class="hljs-string">"mt-5 mb-3 h3"</span>&gt;Register&lt;/h1&gt;
    
    &lt;partial name=<span class="hljs-string">"_Notification"</span>&gt;
</div></code></pre>
<p>When we run the application we get a <code>System.InvalidOperationException</code> error caused by the DbContexts.</p>
<h2 id="handling-multiple-dbcontexts">Handling multiple DbContexts</h2>
<p>We get the error here.</p>
<pre class="hljs"><code><div>    public BlogDbContext(DbContextOptions options) : base(options)
    {
    }
</div></code></pre>
<p>Now that we have two DbContexts we have to name which context we are using.</p>
<pre class="hljs"><code><div>    public BlogDbContext(DbContextOptions&lt;BlogDbContext&gt; options) : base(options)
    {
    }
</div></code></pre>
<p>Do this with the <code>AuthDbContext</code> as well.</p>
<pre class="hljs"><code><div>    public AuthDbContext(DbContextOptions&lt;AuthDbContext&gt; options) : base(options)
    {
    }
</div></code></pre>
<h2 id="testing-register-functionality">Testing Register functionality</h2>
<p>I create a new user and get an error. Identity has requirements for creating a new User password.</p>
<p>We can change these requirements in <code>Program.cs</code> by adding a new Services configuration option.</p>
<pre class="hljs"><code><div>    builder.Services.Configure&lt;IdentityOptions&gt;(options =&gt;
    {
        // Default password settings
        options.Password.RequireDigit = <span class="hljs-literal">true</span>;
        options.Password.RequireNonAlphanumeric = <span class="hljs-literal">true</span>;
        options.Password.RequireUppercase = <span class="hljs-literal">false</span>;
        options.Password.RequiredLength = 6;
    });
</div></code></pre>
<p>Change menu items on the <code>Layout.cshtml</code> page.</p>
<p>Under the <code>ul</code> with a class of &quot;navbar-nav flex-grow-1&quot; add the following section.</p>
<pre class="hljs"><code><div>    ...
    &lt;/ul&gt;
    &lt;div class=<span class="hljs-string">"d-flex"</span>&gt;
        &lt;a href=<span class="hljs-string">"/login"</span> class=<span class="hljs-string">"btn btn-light text-dark me-3"</span>&gt;Login&lt;/a&gt;
        &lt;a href=<span class="hljs-string">"/register"</span> class=<span class="hljs-string">"btn btn-light text-dark me-3"</span>&gt;Register&lt;/a&gt;
    &lt;/div&gt;
</div></code></pre>
<p>This adds <code>Login</code> and <code>Register</code> buttons.</p>
<h2 id="implement-the-login-page-and-functionality">Implement the Login page and functionality</h2>
<p>Create a Razor class form named <code>Login</code>.</p>
<pre class="hljs"><code><div>&lt;div class=<span class="hljs-string">"container mx-auto"</span>&gt;
    &lt;div class=<span class="hljs-string">"row justify-content-center"</span>&gt;
        &lt;div class=<span class="hljs-string">"col-12 col-lg-6"</span>&gt;

            &lt;h1 class=<span class="hljs-string">"mt-5 mb-3 h3"</span>&gt;Login&lt;/h1&gt;

            &lt;partial name=<span class="hljs-string">"_Notification"</span>&gt;

                &lt;form method=<span class="hljs-string">"post"</span>&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;label class=<span class="hljs-string">"form-label"</span>&gt;Username&lt;/label&gt;
                        &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">"text"</span> class=<span class="hljs-string">"form-control"</span> asp-for=<span class="hljs-string">"LoginViewModel.Username"</span> required /&gt;
                    &lt;/div&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;label class=<span class="hljs-string">"form-label"</span>&gt;Password&lt;/label&gt;
                        &lt;input <span class="hljs-built_in">type</span>=<span class="hljs-string">"password"</span> class=<span class="hljs-string">"form-control"</span> asp-for=<span class="hljs-string">"LoginViewModel.Password"</span> required minlength=<span class="hljs-string">"6"</span> /&gt;
                    &lt;/div&gt;

                    &lt;div class=<span class="hljs-string">"mb-3"</span>&gt;
                        &lt;button <span class="hljs-built_in">type</span>=<span class="hljs-string">"submit"</span> class=<span class="hljs-string">"btn bg-dark text-light"</span>&gt;Login&lt;/button&gt;
                    &lt;/div&gt;

                &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</div></code></pre>
<h3 id="logincshtmlcs">Login.cshtml.cs</h3>
<pre class="hljs"><code><div>    private <span class="hljs-built_in">readonly</span> SignInManager&lt;IdentityUser&gt; signInManager;
    
    [BindProperty]
    public Login LoginViewModel { get; <span class="hljs-built_in">set</span>; }
    
    public LoginModel(SignInManager&lt;IdentityUser&gt; signInManager)
    {
        this.signInManager = signInManager;
    }
    
    public async Task&lt;IActionResult&gt; OnPost(string? ReturnUrl)
    {
        <span class="hljs-keyword">if</span> (ModelState.IsValid)
        {
            var signInResult = await signInManager.PasswordSignInAsync(
            LoginViewModel.Username, LoginViewModel.Password, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);

            <span class="hljs-keyword">if</span> (signInResult.Succeeded)
            {
                <span class="hljs-keyword">if</span> (!string.IsNullOrWhiteSpace(ReturnUrl))
                {
                    <span class="hljs-built_in">return</span> RedirectToPage(ReturnUrl);
                }
            
                <span class="hljs-built_in">return</span> RedirectToPage(<span class="hljs-string">"Index"</span>);
            }
            <span class="hljs-keyword">else</span>
            {
                ViewData[<span class="hljs-string">"Notification"</span>] = new Notification
                {
                    Type = Enums.NotificationType.Error,
                    Message = <span class="hljs-string">"Unable to login"</span>
                };
            
                <span class="hljs-built_in">return</span> Page();
            }
        }

        <span class="hljs-built_in">return</span> Page();
    }
</div></code></pre>
<p>We use ASP.NET Core's SignIn Identity management to login.</p>
<p>In _Layout.cshtml we need to add the SignIn Identity. At the top of the page.</p>
<pre class="hljs"><code><div>    @using Microsoft.AspNetCore.Identity
    @inject SignInManager&lt;IdentityUser&gt; signInManager
</div></code></pre>
<p>Now we need to change the Login button code.</p>
<pre class="hljs"><code><div>    &lt;div class=<span class="hljs-string">"d-flex align-items-center text-light"</span>&gt;
        @<span class="hljs-keyword">if</span> (signInManager.IsSignedIn(User))
        {
            &lt;div class=<span class="hljs-string">"me-2"</span>&gt;
                @User?.Identity?.Name
            &lt;/div&gt;

            &lt;a href=<span class="hljs-string">"/logout"</span> class=<span class="hljs-string">"btn btn-light text-dark me-3"</span>&gt;Logout&lt;/a&gt;
        }
        <span class="hljs-keyword">else</span>
        {
            &lt;a href=<span class="hljs-string">"/login"</span> class=<span class="hljs-string">"btn btn-light text-dark me-3"</span>&gt;Login&lt;/a&gt;
            &lt;a href=<span class="hljs-string">"/register"</span> class=<span class="hljs-string">"btn btn-light text-dark me-3"</span>&gt;Register&lt;/a&gt;
        }
    &lt;/div&gt;
</div></code></pre>
<p>This will change the Login button layout so that if we are logged in we will only see the Logout button and the users name. If we aren't logged in we will see the Login and Register buttons.</p>
<p>The logged in button view.</p>
<p><img src="assets/images/logged-in-view.jpg" alt="Logged in view" title="Logged in view"></p>
<h2 id="implement-logout-functionality">Implement Logout functionality</h2>
<p>Create a <code>Logout.cshtml</code> Razor page.</p>
<p>We aren't interested in the Razor page, just the <code>Logout.cshtml.cs</code> Code Behind class.</p>
<pre class="hljs"><code><div>    private <span class="hljs-built_in">readonly</span> SignInManager&lt;IdentityUser&gt; signInManager;

    public LogoutModel(SignInManager&lt;IdentityUser&gt; signInManager)
    {
        this.signInManager = signInManager;
    }

    public async Task&lt;IActionResult&gt; <span class="hljs-function"><span class="hljs-title">OnGet</span></span>()
    {
        await signInManager.SignOutAsync();

        <span class="hljs-built_in">return</span> RedirectToPage(<span class="hljs-string">"Index"</span>);
    }
</div></code></pre>
<p>Once again we use the <code>SignInManager</code> class from Identity. This time we just sign out and redirect back to the Index page.</p>
<h2 id="add-user-roles">Add User Roles</h2>
<p>We have completed the <strong>authentication</strong> of our users and now we need to give them roles that can <strong>authorise</strong> what they have rights to.</p>
<p>In the <code>Register.cshtml.cs</code> Code Behind class we have <strong>authenticated</strong> a user but we also need to give the user <strong>authorisation</strong>.</p>
<p>This is our updated <code>OnPost()</code> method</p>
<pre class="hljs"><code><div>    public async Task&lt;IActionResult&gt; <span class="hljs-function"><span class="hljs-title">OnPost</span></span>()
    {
        var user = new IdentityUser
        {
            UserName = RegisterViewModel.Username,
            Email = RegisterViewModel.Email
        };

        var result = await userManager.CreateAsync(user, RegisterViewModel.Password);

        <span class="hljs-keyword">if</span> (result.Succeeded)
        {
            var rolesResult = await userManager.AddToRoleAsync(user, <span class="hljs-string">"User"</span>);

            <span class="hljs-keyword">if</span> (rolesResult.Succeeded)
            {
                ViewData[<span class="hljs-string">"Notification"</span>] = new Notification
                {
                    Type = Enums.NotificationType.Success,
                    Message = <span class="hljs-string">"User registered successfully!"</span>
                };

                <span class="hljs-built_in">return</span> Page();
            }
        }

        ViewData[<span class="hljs-string">"Notification"</span>] = new Notification
        {
            Type = Enums.NotificationType.Error,
            Message = <span class="hljs-string">"User NOT registered!"</span>
        };

        <span class="hljs-built_in">return</span> Page();
    }
</div></code></pre>
<p>In the code above we have given the new user the <code>User</code> role once we have checked that the new user was created successfully.</p>
<h2 id="adding-authorisation-to-the-admin-page">Adding Authorisation to the Admin page</h2>
<p>We have 3 different types of users.</p>
<ul>
<li>Admin</li>
<li>SuperAdmin</li>
<li>User</li>
</ul>
<p>We have 3 types of pages</p>
<ul>
<li>Admin pages (Admin, SuperAdmin)</li>
<li>Blog pages (All)</li>
<li>Register &amp; Login pages (All)</li>
</ul>
<p>Now we want to add Authorisation to our Admin pages. This will bock basic users from seeing these pages.</p>
<p>We add the following to all page classes in the Admin section</p>
<pre class="hljs"><code><div>    [Authorize]
</div></code></pre>
<p>Now if a user isn't logged in they will be blocked from accessing all of these pages. They will get this message.</p>
<blockquote>
<p><a href="https://localhost:7100/Account/Login?ReturnUrl=%2Fadmin%2Fblogs%2Fadd">https://localhost:7100/Account/Login?ReturnUrl=%2Fadmin%2Fblogs%2Fadd</a></p>
</blockquote>
<p>We can redirect the user to the Login page by creating another service in <code>Program.cs</code>.</p>
<pre class="hljs"><code><div>    builder.Services.ConfigureApplicationCookie(options =&gt;
    {
        options.LoginPath = <span class="hljs-string">"/Login"</span>;
    });
</div></code></pre>
<p>This service gracefully redirects a user to the Login page.</p>
<p>Now if any user is logged in they can access the Admin pages no matter what type of user they are. We now need to restrict access to the Admin pages to only the <code>Admin</code> and <code>SuperAdmin</code> users.</p>
<h2 id="adding-roles-based-authorisation-to-the-admin-pages">Adding Roles based authorisation to the Admin pages</h2>
<ul>
<li>SuperAdmin has the SuperAdmin, Admin and User roles</li>
<li>Admin has the Admin and User roles</li>
<li>User has only the User role</li>
</ul>
<p>Based on this we can add Roles to our <code>Authorize</code> attribute.</p>
<pre class="hljs"><code><div>    [Authorize(Roles = <span class="hljs-string">"Admin"</span>)]
</div></code></pre>
<p><strong>Note:</strong> we don't have to add <code>SuperAdmin</code> because that already has the <code>Admin</code> role.</p>
<p>Now if I login as a basic User I get the <strong>AccessDenied</strong> error. The is not the behavior that we want to happen. We can change this in the <code>Program.cs</code> class.</p>
<p>Change the service to this.</p>
<pre class="hljs"><code><div>    builder.Services.ConfigureApplicationCookie(options =&gt;
    {
        options.LoginPath = <span class="hljs-string">"/Login"</span>;
        options.AccessDeniedPath = <span class="hljs-string">"/AccessDenied"</span>;
    });
</div></code></pre>
<p>Now build an <code>AccessDenied.cshtml</code> page.</p>
<pre class="hljs"><code><div>&lt;div class=<span class="hljs-string">"container mt-5 mb-3"</span>&gt;
    &lt;h2&gt;You are unable to access this page.&lt;/h2&gt;
&lt;/div&gt;
&lt;form method=<span class="hljs-string">"get"</span>&gt;
    &lt;div class=<span class="hljs-string">"container mt-5 mb-3"</span>&gt;
        &lt;button <span class="hljs-built_in">type</span>=<span class="hljs-string">"submit"</span> class=<span class="hljs-string">"btn bg-dark text-light"</span> asp-page=<span class="hljs-string">"/Index"</span>&gt;Home page&lt;/button&gt;
    &lt;/div&gt;
&lt;/form&gt;
</div></code></pre>
<p>This allows the user to go back to the Home page.</p>
<p>Let's go one step further and block the user from seeing the Admin dropdown menu. In the <code>_Layout.cshtml</code> page.</p>
<pre class="hljs"><code><div>@<span class="hljs-keyword">if</span> (signInManager.IsSignedIn(User) &amp;&amp; User.IsInRole(<span class="hljs-string">"Admin"</span>))
{
    &lt;li class=<span class="hljs-string">"nav-item dropdown"</span>&gt;
        &lt;a class=<span class="hljs-string">"nav-link dropdown-toggle"</span> href=<span class="hljs-string">"#"</span> role=<span class="hljs-string">"button"</span> data-bs-toggle=<span class="hljs-string">"dropdown"</span> aria-expanded=<span class="hljs-string">"false"</span> id=<span class="hljs-string">"navbarDropdownAdmin"</span>&gt;
            Admin
        &lt;/a&gt;
        &lt;ul class=<span class="hljs-string">"dropdown-menu"</span>&gt;
            &lt;li&gt;
                &lt;a class=<span class="hljs-string">"dropdown-item"</span> href=<span class="hljs-string">"/admin/blogs/add"</span>&gt;Add Blog Post&lt;/a&gt;
            &lt;/li&gt;
            &lt;li&gt;
                &lt;a class=<span class="hljs-string">"dropdown-item"</span> href=<span class="hljs-string">"/admin/blogs/list"</span>&gt;List Blog Posts&lt;/a&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
    &lt;/li&gt;
}
</div></code></pre>
<p>This will make the <strong>Admin</strong> dropdown disappear for a basic user.</p>
<p>This is an example of what a basic user menu looks like.</p>
<p><img src="assets/images/basic-user-menu.jpg" alt="Basic user menu" title="Basic user menu"></p>
<h2 id="redirecting-users-based-on-the-return-url">Redirecting users based on the return Url</h2>
<p>On the <code>login.cshtml.cs</code> Code Behind class we can capture the return url so that if a user isn't authenticated we can send them to the login page and remember where they had came from. When they authenticate we will send them back to the page they came from.</p>
<pre class="hljs"><code><div>    public async Task&lt;IActionResult&gt; OnPost(string? ReturnUrl)
    {
        <span class="hljs-keyword">if</span> (ModelState.IsValid)
        {
            var signInResult = await signInManager.PasswordSignInAsync(
            LoginViewModel.Username, LoginViewModel.Password, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);

            <span class="hljs-keyword">if</span> (signInResult.Succeeded)
            {
                <span class="hljs-keyword">if</span> (!string.IsNullOrWhiteSpace(ReturnUrl))
                {
                    <span class="hljs-built_in">return</span> RedirectToPage(ReturnUrl);
                }

                <span class="hljs-built_in">return</span> RedirectToPage(<span class="hljs-string">"Index"</span>);
            }
            <span class="hljs-keyword">else</span>
            {
                ...
</div></code></pre>
<p>In the <code>OnPost()</code> statement we pass in <code>ReturnUrl</code> as a string parameter.</p>
<p>Once the User has logged in successfully we check for a return url and if there is one we will redirect the User to that page otherwise we will send them back to the Index page.</p>

</body>
</html>
